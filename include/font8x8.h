#pragma once
#include <cstring>

static unsigned char font8x8_basic[128][8];

static void initFont8x8() {
    memset(font8x8_basic, 0, sizeof(font8x8_basic));

    auto set = [](char c, std::initializer_list<unsigned char> rows) {
        int i = 0;
        for (unsigned char v : rows) font8x8_basic[(unsigned char)c][i++] = v;
    };

    set('A', {0x18, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x42, 0});
    set('B', {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0});
    set('C', {0x3C, 0x42, 0x40, 0x40, 0x40, 0x42, 0x3C, 0});
    set('D', {0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0});
    set('E', {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0});
    set('F', {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0});
    set('G', {0x3C, 0x42, 0x40, 0x4E, 0x42, 0x42, 0x3E, 0});
    set('H', {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0});
    set('I', {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0});
    set('J', {0x0E, 0x04, 0x04, 0x04, 0x44, 0x44, 0x38, 0});
    set('K', {0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0});
    set('L', {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0});
    set('M', {0x42, 0x66, 0x5A, 0x5A, 0x42, 0x42, 0x42, 0});
    set('N', {0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0});
    set('O', {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0});
    set('P', {0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0});
    set('Q', {0x3C, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0});
    set('R', {0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0});
    set('S', {0x3E, 0x40, 0x40, 0x3C, 0x02, 0x02, 0x7C, 0});
    set('T', {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0});
    set('U', {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0});
    set('V', {0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0});
    set('W', {0x42, 0x42, 0x5A, 0x5A, 0x5A, 0x66, 0x42, 0});
    set('X', {0x42, 0x24, 0x18, 0x18, 0x18, 0x24, 0x42, 0});
    set('Y', {0x42, 0x24, 0x18, 0x18, 0x18, 0x18, 0x18, 0});
    set('Z', {0x7E, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7E, 0});

    set('0', {0x3C, 0x42, 0x46, 0x4A, 0x52, 0x62, 0x3C, 0});
    set('1', {0x08, 0x18, 0x28, 0x08, 0x08, 0x08, 0x3E, 0});
    set('2', {0x3C, 0x42, 0x02, 0x0C, 0x30, 0x40, 0x7E, 0});
    set('3', {0x3C, 0x42, 0x02, 0x1C, 0x02, 0x42, 0x3C, 0});
    set('4', {0x0C, 0x14, 0x24, 0x44, 0x7E, 0x04, 0x04, 0});
    set('5', {0x7E, 0x40, 0x40, 0x7C, 0x02, 0x42, 0x3C, 0});
    set('6', {0x3C, 0x40, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0});
    set('7', {0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x10, 0});
    set('8', {0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0});
    set('9', {0x3C, 0x42, 0x42, 0x3E, 0x02, 0x24, 0x18, 0});

    set('>', { 0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00});
    set('<', { 0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00});
    set(':', {0, 0x18, 0x18, 0, 0x18, 0x18, 0});
    set('-', {0, 0, 0, 0x7E, 0, 0, 0, 0});
}

void drawChar(Framebuffer& fb, int x, int yTop, char c, Color col,
              int scale = 2) {
    auto& glyph = font8x8_basic[(unsigned char)c];

    for (int row = 0; row < 8; row++) {
        for (int colBit = 0; colBit < 8; colBit++) {
            if (glyph[row] & (1 << (7 - colBit))) {
                for (int dy = 0; dy < scale; ++dy) {
                    for (int dx = 0; dx < scale; ++dx) {
                        int px = x + colBit * scale + dx;
                        int pyFromTop = yTop + row * scale + dy;

                        int py = fb.height() - 1 - pyFromTop;

                        fb.setRaw(px, py, col);
                    }
                }
            }
        }
    }
}

void drawText(Framebuffer& fb, int x, int yTop, const std::string& text,
              Color col, int scale = 2) {
    int advance = 8 * scale;
    for (char c : text) {
        drawChar(fb, x, yTop, c, col, scale);
        x += advance;
    }
}